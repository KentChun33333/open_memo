# OpenMemo Security Enhancements & Deployment Guide

*Date: February 20, 2026*

## Overview

This document summarizes the critical security patches applied to the `open_memo` WebApp and outlines the required deployment procedures for running the application securely on public cloud infrastructure (like Google Cloud Platform / Cloud Run), especially since this repository is public.

## 1. Securing Private Nanobot Chat Logs (Static File Mounts)

**The Vulnerability:** FastAPI's `StaticFiles` completely sidestepped the router authentication. `app.mount("/nanobot-status")` exposed the entire directory, meaning anyone could download private chat histories generated by the Nanobot backend by navigating to `https://your-domain/nanobot-status/workspace/sessions/...jsonl`.

**The Fix:**
The static `app.mount` was removed. We implemented native authenticated `GET` endpoints (`/api/nanobot-status/{file_path:path}`) using the `FileResponse` object, which injects the `Depends(get_current_user)` authentication middleware. The React frontend was updated to attach the user's JWT Bearer token when making `fetch` calls.

*Note: The `reflections.json` file remains explicitly whitelisted to support the "Active Consciousness" public-facing web feature.*

## 2. Hardcoded Credentials & Forged JWT Tokens

**The Vulnerability:** As a public repository, anyone can see the default credentials in `backend/config.py` (`admin_password="openmemo"`, `secret_key="change-me-in-production-please"`). If deployed to a cloud provider without changing these, an attacker could either directly log in as Admin, or cryptographically forge their own authentication JWT tokens offline and bypass login completely.

**The Fix:**
A `model_validator` was added to the Pydantic `Settings` class in `config.py`. If the FastAPI server boots up in "Production" mode (`debug=False`), the server will explicitly check if the password or secret key match the defaults. If they do, **the server will immediately crash and refuse to boot.** This fail-closed approach ensures the app cannot be accidentally deployed with insecure credentials.

---

## Google Cloud Platform (GCP) Deployment Instructions

To successfully deploy the new security-hardened version of `open_memo` to Cloud Run, you must inject real, strong credentials into the container at Runtime so they override the default public code.

### Setting Environment Variables in Cloud Run

1. Go to the **Google Cloud Console**.
2. Navigate to **Cloud Run** and click on your `open_memo` service.
3. Click **Edit & Deploy New Revision**.
4. Scroll down and click **Variables & Secrets** -> **Environment variables**.
5. Click **Add Variable** and create the following two overrides:

   * **Name:** `OPENMEMO_ADMIN_PASSWORD`
     * **Value:** *(Set a highly secure password for your web login)*
   * **Name:** `OPENMEMO_SECRET_KEY`
     * **Value:** *(Generate a long, random string. E.g., `openssl rand -hex 32`)*

6. (Optional) Check **Secret Manager**: For enterprise-grade security, you can store these strings in GCP Secret Manager and mount them securely instead of using plaintext environment variables.
7. Click **Deploy**.

When the Cloud Run server boots up, it will read those two variables safely out of the GCP Environment memory instead of using the insecure defaults written in the code.
